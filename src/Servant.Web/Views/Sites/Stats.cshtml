@using System
@using Servant.Business.Objects.Enums
@using Servant.Web.Modules
@inherits Nancy.ViewEngines.Razor.NancyRazorViewBase<dynamic>
@{
    Layout = "Sites/_Details.cshtml";
    ViewBag.Title = "Index";
    ViewBag.ActiveMenuItem = "sites";
    ViewBag.ActiveSubmenuItem = "stats";
}   

<ul class="sections active-@Model.ActiveSection">
    <li class="section1"><a href="/sites/@Model.Site.IisId/stats/">Today</a></li>
    <li class="section2"><a href="/sites/@Model.Site.IisId/stats/?r=lastweek">Last week</a></li>
    <li class="section3"><a href="/sites/@Model.Site.IisId/stats/?r=lastmonth">Last month</a></li>
</ul>    

<div class="clear"></div>

@if(!Model.HasEntries)
{
    <h4 class="margin-top30">Sorry, there's like no requests for the selected period.</h4>
} else {
    <p class="gray margin-top10"><strong>@Model.TotalRequests</strong> requests in this period.</p>

    if (Model.Range == StatsRange.Today) {
    <h3 class="margin-top30">Latest requests</h3>
    <span>IIS logs flushed @DateTime.Now.ToString("hh:mm:ss")</span>
    <table class="table table-striped margin-top10">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th class="span6">URL</th>
                <th>Execution time</th>
            </tr>

        </thead>
        @foreach (Servant.Business.Objects.LogEntry entry in Model.LatestEntries)
        {
            <tr>
                <td><span class="time-diff">@entry.DateTime</span></td>
                <td>@entry.Uri@entry.Querystring</td>
                <td>@(entry.TimeTaken)ms</td>
            </tr>
        }
    </table>
    }


    <h3 class="margin-top30">Most active clients</h3>
    <table class="table table-striped margin-top10">
        <thead>
            <tr>
                <th class="span1">IP Address</th>
                <th class="span4">Agent string</th>
                <th class="span1"># of requests</th>
            </tr>

        </thead>
        @foreach (var entry in Model.MostActiveClients)
        {
            <tr>
                <td>@entry.ClientIpAddress</td>
                <td style="word-break:break-all ">@entry.LatestAgentstring</td>
                <td>@entry.Count</td>
            </tr>
        }
    </table>



<h3 class="margin-top30">Most expensive requests</h3>
<table class="table table-striped margin-top10">
    <thead>
        <tr>
            <th class="span4">URL</th>
            <th class="span2">Avg execution time</th>
            <th class="span1"># of requests</th>
        </tr>

    </thead>
    @foreach (var entry in Model.MostExpensiveRequests)
    {
        <tr>
            <td>@entry.Uri@entry.Querystring</td>
            <td>@(entry.AverageTimeTaken)ms</td>
            <td>@entry.Count</td>
        </tr>
    }
</table>




<h3 class="margin-top30">Most popular URLs</h3>
    <table class="table table-striped margin-top10">
        <thead>
            <tr>
                <th class="span6">URL</th>
                <th class="span1"># of requests</th>
            </tr>

        </thead>
        @foreach (var entry in Model.MostActiveUrls)
        {
            <tr>
                <td>@entry.Uri@entry.Querystring</td>
                <td>@entry.Count</td>
            </tr>
        }
    </table>
}